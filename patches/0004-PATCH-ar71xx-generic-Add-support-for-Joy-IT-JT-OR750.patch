From 2bae7be4dbd13b11ebe72c47d967db561d9fd570 Mon Sep 17 00:00:00 2001
From: Dark4MD <github.web@manu.li>
Date: Sun, 26 Jan 2020 03:00:43 +0100
Subject: [PATCH] [PATCH] ar71xx-generic: Add support for Joy-IT JT-OR750i

THIS PATCH IS FOR TESTING PURPOSES ONLY.
---
 .../luasrc/lib/gluon/upgrade/010-primary-mac  |   1 +
 ...1xx-add-support-for-joy-it-jt-or750i.patch | 350 ++++++++++++++++++
 targets/ar71xx-generic                        |   8 +
 3 files changed, 359 insertions(+)
 create mode 100644 patches/openwrt/0009-ar71xx-add-support-for-joy-it-jt-or750i.patch

diff --git a/package/gluon-core/luasrc/lib/gluon/upgrade/010-primary-mac b/package/gluon-core/luasrc/lib/gluon/upgrade/010-primary-mac
index fd1f1232..308d8909 100755
--- a/package/gluon-core/luasrc/lib/gluon/upgrade/010-primary-mac
+++ b/package/gluon-core/luasrc/lib/gluon/upgrade/010-primary-mac
@@ -67,6 +67,7 @@ local primary_addrs = {
 			'archer-c7-v4',
 			'archer-c7-v5',
 			'carambola2',
+			'jt-or750i',
 			'koala',
 			'mr600',
 			'mr600v2',
diff --git a/patches/openwrt/0009-ar71xx-add-support-for-joy-it-jt-or750i.patch b/patches/openwrt/0009-ar71xx-add-support-for-joy-it-jt-or750i.patch
new file mode 100644
index 00000000..aed24e69
--- /dev/null
+++ b/patches/openwrt/0009-ar71xx-add-support-for-joy-it-jt-or750i.patch
@@ -0,0 +1,350 @@
+From 3fc3600061ef6478652804a34cc351e3aaffa299 Mon Sep 17 00:00:00 2001
+From: Dark4MD <github.web@manu.li>
+Date: Sun, 26 Jan 2020 02:08:00 +0100
+Subject: [PATCH] ar71xx: Add support for Joy-IT JT-OR750i
+
+Signed-off-by: Vincent Wiemann <vcw@derowe.com>
+---
+ package/boot/uboot-envtools/files/ar71xx      |   1 +
+ .../ar71xx/base-files/etc/board.d/01_leds     |  14 +-
+ .../ar71xx/base-files/etc/board.d/02_network  |   1 +
+ target/linux/ar71xx/base-files/etc/diag.sh    |   3 +
+ .../etc/hotplug.d/firmware/11-ath10k-caldata  |   1 +
+ target/linux/ar71xx/base-files/lib/ar71xx.sh  |   3 +
+ .../ar71xx/base-files/lib/upgrade/platform.sh |   1 +
+ target/linux/ar71xx/config-4.14               |   1 +
+ .../files/arch/mips/ath79/Kconfig.openwrt     |  11 ++
+ .../ar71xx/files/arch/mips/ath79/Makefile     |   1 +
+ .../files/arch/mips/ath79/mach-jt-or750i.c    | 122 ++++++++++++++++++
+ .../ar71xx/files/arch/mips/ath79/machtypes.h  |   1 +
+ target/linux/ar71xx/generic/config-default    |   1 +
+ target/linux/ar71xx/image/generic.mk          |  12 ++
+ 14 files changed, 169 insertions(+), 4 deletions(-)
+ create mode 100644 target/linux/ar71xx/files/arch/mips/ath79/mach-jt-or750i.c
+
+diff --git a/package/boot/uboot-envtools/files/ar71xx b/package/boot/uboot-envtools/files/ar71xx
+index 9625c6bdd11..fe6bc865cd3 100644
+--- a/package/boot/uboot-envtools/files/ar71xx
++++ b/package/boot/uboot-envtools/files/ar71xx
+@@ -38,6 +38,7 @@ gl-ar300m|\
+ gl-ar750|\
+ hornet-ub|\
+ hornet-ub-x2|\
++jt-or750i|\
+ jwap230|\
+ koala|\
+ mr1750|\
+diff --git a/target/linux/ar71xx/base-files/etc/board.d/01_leds b/target/linux/ar71xx/base-files/etc/board.d/01_leds
+index bd589c1cff2..90e47722ce6 100755
+--- a/target/linux/ar71xx/base-files/etc/board.d/01_leds
++++ b/target/linux/ar71xx/base-files/etc/board.d/01_leds
+@@ -111,14 +111,20 @@ n5q)
+ 		;;
+ 	esac
+ 	;;
+-archer-c25-v1)
++archer-c25-v1|\
++jt-or750i)
+ 	ucidef_set_led_netdev "wan" "WAN" "$board:green:wan" "eth0"
+-	ucidef_set_led_wlan "wlan" "WLAN" "$board:green:wlan2g" "phy1tpt"
+-	ucidef_set_led_wlan "wlan5g" "WLAN5G" "$board:green:wlan5g" "phy0tpt"
+ 	ucidef_set_led_switch "lan1" "LAN1" "$board:green:lan1" "switch0" "0x10"
+ 	ucidef_set_led_switch "lan2" "LAN2" "$board:green:lan2" "switch0" "0x08"
+ 	ucidef_set_led_switch "lan3" "LAN3" "$board:green:lan3" "switch0" "0x04"
+-	ucidef_set_led_switch "lan4" "LAN4" "$board:green:lan4" "switch0" "0x02"
++
++	case "$board" in
++	archer-c25-v1)
++		ucidef_set_led_switch "lan4" "LAN4" "$board:green:lan4" "switch0" "0x02"
++		ucidef_set_led_wlan "wlan" "WLAN" "$board:green:wlan2g" "phy1tpt"
++		ucidef_set_led_wlan "wlan5g" "WLAN5G" "$board:green:wlan5g" "phy0tpt"
++		;;
++	esac
+ 	;;
+ archer-c5|\
+ archer-c7)
+diff --git a/target/linux/ar71xx/base-files/etc/board.d/02_network b/target/linux/ar71xx/base-files/etc/board.d/02_network
+index 99021eae656..794496812d5 100755
+--- a/target/linux/ar71xx/base-files/etc/board.d/02_network
++++ b/target/linux/ar71xx/base-files/etc/board.d/02_network
+@@ -476,6 +476,7 @@ ar71xx_setup_interfaces()
+ 		ucidef_add_switch "switch0" \
+ 			"0:lan:4" "1:lan:3" "2:lan:2" "3:lan:1" "5@eth1"
+ 		;;
++	jt-or750i|\
+ 	routerstation-pro)
+ 		ucidef_set_interfaces_lan_wan "eth1.1" "eth0"
+ 		ucidef_add_switch "switch0" \
+diff --git a/target/linux/ar71xx/base-files/etc/diag.sh b/target/linux/ar71xx/base-files/etc/diag.sh
+index 8ff75627a53..722fb1c26c0 100644
+--- a/target/linux/ar71xx/base-files/etc/diag.sh
++++ b/target/linux/ar71xx/base-files/etc/diag.sh
+@@ -264,6 +264,9 @@ get_status_led() {
+ 	ja76pf2)
+ 		status_led="jjplus:green:led1"
+ 		;;
++	jt-or750i)
++		status_led="$board:inv_red:status"
++		;;
+ 	jwap230)
+ 		status_led="$board:green:led1"
+ 		;;
+diff --git a/target/linux/ar71xx/base-files/etc/hotplug.d/firmware/11-ath10k-caldata b/target/linux/ar71xx/base-files/etc/hotplug.d/firmware/11-ath10k-caldata
+index 718fd7555c7..948b95e5f3d 100644
+--- a/target/linux/ar71xx/base-files/etc/hotplug.d/firmware/11-ath10k-caldata
++++ b/target/linux/ar71xx/base-files/etc/hotplug.d/firmware/11-ath10k-caldata
+@@ -76,6 +76,7 @@ case "$FIRMWARE" in
+ 	dlan-pro-1200-ac|\
+ 	e1700ac-v2|\
+ 	e600gac-v2|\
++	jt-or750i|\
+ 	minibox-v3.2|\
+ 	oolite-v5.2|\
+ 	oolite-v5.2-dev|\
+diff --git a/target/linux/ar71xx/base-files/lib/ar71xx.sh b/target/linux/ar71xx/base-files/lib/ar71xx.sh
+index 044ef4eae5e..f5521ad2a07 100755
+--- a/target/linux/ar71xx/base-files/lib/ar71xx.sh
++++ b/target/linux/ar71xx/base-files/lib/ar71xx.sh
+@@ -974,6 +974,9 @@ ar71xx_board_detect() {
+ 	*"JA76PF2")
+ 		name="ja76pf2"
+ 		;;
++	*"JT-OR750i")
++		name="jt-or750i"
++		;;
+ 	*"JWAP003")
+ 		name="jwap003"
+ 		;;
+diff --git a/target/linux/ar71xx/base-files/lib/upgrade/platform.sh b/target/linux/ar71xx/base-files/lib/upgrade/platform.sh
+index e2bd946d29b..984a5805790 100755
+--- a/target/linux/ar71xx/base-files/lib/upgrade/platform.sh
++++ b/target/linux/ar71xx/base-files/lib/upgrade/platform.sh
+@@ -275,6 +275,7 @@ platform_check_image() {
+ 	gl-usb150|\
+ 	hiwifi-hc6361|\
+ 	hornet-ub-x2|\
++	jt-or750i|\
+ 	jwap230|\
+ 	lbe-m5|\
+ 	lima|\
+diff --git a/target/linux/ar71xx/config-4.14 b/target/linux/ar71xx/config-4.14
+index 9a524fae431..a4ca5ff699f 100644
+--- a/target/linux/ar71xx/config-4.14
++++ b/target/linux/ar71xx/config-4.14
+@@ -137,6 +137,7 @@ CONFIG_ATH79=y
+ # CONFIG_ATH79_MACH_HIWIFI_HC6361 is not set
+ # CONFIG_ATH79_MACH_HORNET_UB is not set
+ # CONFIG_ATH79_MACH_JA76PF is not set
++# CONFIG_ATH79_MACH_JT_OR750I is not set
+ # CONFIG_ATH79_MACH_JWAP003 is not set
+ # CONFIG_ATH79_MACH_JWAP230 is not set
+ # CONFIG_ATH79_MACH_KOALA is not set
+diff --git a/target/linux/ar71xx/files/arch/mips/ath79/Kconfig.openwrt b/target/linux/ar71xx/files/arch/mips/ath79/Kconfig.openwrt
+index 6fd78c46a09..a95698b4dba 100644
+--- a/target/linux/ar71xx/files/arch/mips/ath79/Kconfig.openwrt
++++ b/target/linux/ar71xx/files/arch/mips/ath79/Kconfig.openwrt
+@@ -988,6 +988,17 @@ config ATH79_MACH_JA76PF
+ 	select ATH79_DEV_M25P80
+ 	select ATH79_DEV_USB
+ 
++config ATH79_MACH_JT_OR750I
++	bool "Joy-IT OR750i support"
++	select SOC_QCA953X
++	select ATH79_DEV_AP9X_PCI if PCI
++	select ARH79_DEV_ETH
++	select ARH79_DEV_GPIO_BUTTONS
++	select ATH79_DEV_LEDS_GPIO
++	select ATH79_DEV_M25P80
++	select ATH79_DEV_USB
++	select ATH79_DEV_WMAC
++
+ config ATH79_MACH_JWAP003
+ 	bool "jjPlus JWAP003 board support"
+ 	select SOC_AR71XX
+diff --git a/target/linux/ar71xx/files/arch/mips/ath79/Makefile b/target/linux/ar71xx/files/arch/mips/ath79/Makefile
+index 0265b3d8181..a15b50ba394 100644
+--- a/target/linux/ar71xx/files/arch/mips/ath79/Makefile
++++ b/target/linux/ar71xx/files/arch/mips/ath79/Makefile
+@@ -147,6 +147,7 @@ obj-$(CONFIG_ATH79_MACH_HIVEAP_121)		+= mach-hiveap-121.o
+ obj-$(CONFIG_ATH79_MACH_HIWIFI_HC6361)		+= mach-hiwifi-hc6361.o
+ obj-$(CONFIG_ATH79_MACH_HORNET_UB)		+= mach-hornet-ub.o
+ obj-$(CONFIG_ATH79_MACH_JA76PF)			+= mach-ja76pf.o
++obj-$(CONFIG_ATH79_MACH_JT_OR750I)		+= mach-jt-or750i.o
+ obj-$(CONFIG_ATH79_MACH_JWAP003)		+= mach-jwap003.o
+ obj-$(CONFIG_ATH79_MACH_JWAP230)		+= mach-jwap230.o
+ obj-$(CONFIG_ATH79_MACH_KOALA)			+= mach-koala.o
+diff --git a/target/linux/ar71xx/files/arch/mips/ath79/mach-jt-or750i.c b/target/linux/ar71xx/files/arch/mips/ath79/mach-jt-or750i.c
+new file mode 100644
+index 00000000000..3eb6d0ae333
+--- /dev/null
++++ b/target/linux/ar71xx/files/arch/mips/ath79/mach-jt-or750i.c
+@@ -0,0 +1,122 @@
++/*
++ * Joy-IT JT-OR750i board support
++ *
++ * Copyright (C) 2019 Vincent Wiemann <vcw@derowe.com>
++ *
++ * This program is free software; you can redistribute it and/or modify it
++ * under the terms of the GNU General Public License version 2 as published
++ * by the Free Software Foundation.
++ */
++
++#include <linux/gpio.h>
++#include <linux/platform_device.h>
++
++#include <asm/mach-ath79/ath79.h>
++#include <asm/mach-ath79/ar71xx_regs.h>
++
++#include "common.h"
++#include "dev-eth.h"
++#include "dev-gpio-buttons.h"
++#include "dev-leds-gpio.h"
++#include "dev-m25p80.h"
++#include "dev-usb.h"
++#include "dev-wmac.h"
++#include "machtypes.h"
++#include "pci.h"
++
++/* ath10k GPIO is not used as a WLAN-LED, but as a status LED with default
++ * state "on" together with the inverted red status LED for signalling e.g.
++ * failsafe mode
++ */
++#define OR750I_GPIO_LED_STATUS_GREEN	506
++#define OR750I_GPIO_LED_STATUS_RED	13
++#define OR750I_GPIO_LED_LAN1		16
++#define OR750I_GPIO_LED_LAN2		15
++#define OR750I_GPIO_LED_LAN3		14
++#define OR750I_GPIO_LED_WAN		4
++
++#define OR750I_GPIO_BTN_RESET		17
++
++#define OR750I_KEYS_POLL_INTERVAL	20 /* msec */
++#define OR750I_KEYS_DEBOUNCE_INTERVAL	(3 * OR750I_KEYS_POLL_INTERVAL)
++
++#define OR750I_WMAC2G_CALDATA_OFFSET	0x1000
++#define OR750I_WMAC5G_CALDATA_OFFSET	0x5000
++
++static struct gpio_led or750i_gpio_leds[] __initdata = {
++	{
++		.name		= "jt-or750i:green:lan1",
++		.gpio		= OR750I_GPIO_LED_LAN1,
++		.active_low	= 1,
++	}, {
++		.name		= "jt-or750i:green:lan2",
++		.gpio		= OR750I_GPIO_LED_LAN2,
++		.active_low	= 1,
++	}, {
++		.name		= "jt-or750i:green:lan3",
++		.gpio		= OR750I_GPIO_LED_LAN3,
++		.active_low	= 1,
++	}, {
++		.name		= "jt-or750i:green:wan",
++		.gpio		= OR750I_GPIO_LED_WAN,
++		.active_low	= 1,
++	}, {	/* Inverted active_low, because a red status LED looks broken */
++		.name		= "jt-or750i:inv_red:status",
++		.gpio		= OR750I_GPIO_LED_STATUS_RED,
++		.active_low	= 0,
++		.default_state	= 0,
++	}
++};
++
++static struct gpio_keys_button or750i_gpio_keys[] __initdata = {
++	{
++		.desc			= "reset",
++		.type			= EV_KEY,
++		.code			= KEY_RESTART,
++		.debounce_interval	= OR750I_KEYS_DEBOUNCE_INTERVAL,
++		.gpio			= OR750I_GPIO_BTN_RESET,
++		.active_low		= 1,
++	}
++};
++
++static void __init or750i_setup(void)
++{
++	u8 *art = (u8 *) KSEG1ADDR(0x1fff0000);
++
++	ath79_register_m25p80(NULL);
++
++	ath79_setup_ar933x_phy4_switch(false, false);
++
++	ath79_register_mdio(0, 0x0);
++
++	/* WAN */
++	ath79_init_mac(ath79_eth0_data.mac_addr, art, 0);
++	ath79_eth0_data.duplex = DUPLEX_FULL;
++	ath79_eth0_data.phy_if_mode = PHY_INTERFACE_MODE_MII;
++	ath79_eth0_data.phy_mask = BIT(4);
++	ath79_eth0_data.speed = SPEED_100;
++	ath79_register_eth(0);
++
++	/* LAN */
++	ath79_init_mac(ath79_eth1_data.mac_addr, art + 6, 0);
++	ath79_eth1_data.duplex = DUPLEX_FULL;
++	ath79_eth1_data.phy_if_mode = PHY_INTERFACE_MODE_GMII;
++	ath79_switch_data.phy4_mii_en = 1;
++	ath79_switch_data.phy_poll_mask |= BIT(4);
++	ath79_register_eth(1);
++
++	ath79_register_gpio_keys_polled(-1, OR750I_KEYS_POLL_INTERVAL,
++					ARRAY_SIZE(or750i_gpio_keys),
++					or750i_gpio_keys);
++
++	ath79_register_leds_gpio(-1, ARRAY_SIZE(or750i_gpio_leds),
++				 or750i_gpio_leds);
++
++	ath79_register_usb();
++
++	ath79_register_wmac(art + OR750I_WMAC2G_CALDATA_OFFSET, NULL);
++
++	ath79_register_pci();
++}
++
++MIPS_MACHINE(ATH79_MACH_JT_OR750I, "JT-OR750I", "Joy-IT JT-OR750i", or750i_setup);
+diff --git a/target/linux/ar71xx/files/arch/mips/ath79/machtypes.h b/target/linux/ar71xx/files/arch/mips/ath79/machtypes.h
+index 900b4ec87b1..f704b7e0bf3 100644
+--- a/target/linux/ar71xx/files/arch/mips/ath79/machtypes.h
++++ b/target/linux/ar71xx/files/arch/mips/ath79/machtypes.h
+@@ -149,6 +149,7 @@ enum ath79_mach_type {
+ 	ATH79_MACH_HORNET_UB,			/* ALFA Networks Hornet-UB */
+ 	ATH79_MACH_JA76PF,			/* jjPlus JA76PF */
+ 	ATH79_MACH_JA76PF2,			/* jjPlus JA76PF2 */
++	ATH79_MACH_JT_OR750I,			/* Joy-IT JT-OR750i */
+ 	ATH79_MACH_JWAP003,			/* jjPlus JWAP003 */
+ 	ATH79_MACH_JWAP230,			/* jjPlus JWAP230 */
+ 	ATH79_MACH_KOALA,			/* OCEDO Koala */
+diff --git a/target/linux/ar71xx/generic/config-default b/target/linux/ar71xx/generic/config-default
+index 25b58ae91e9..cd7dbe002e5 100644
+--- a/target/linux/ar71xx/generic/config-default
++++ b/target/linux/ar71xx/generic/config-default
+@@ -105,6 +105,7 @@ CONFIG_ATH79_MACH_GS_OOLITE_V5_2=y
+ CONFIG_ATH79_MACH_HIWIFI_HC6361=y
+ CONFIG_ATH79_MACH_HORNET_UB=y
+ CONFIG_ATH79_MACH_JA76PF=y
++CONFIG_ATH79_MACH_JT_OR750I=y
+ CONFIG_ATH79_MACH_JWAP003=y
+ CONFIG_ATH79_MACH_JWAP230=y
+ CONFIG_ATH79_MACH_KOALA=y
+diff --git a/target/linux/ar71xx/image/generic.mk b/target/linux/ar71xx/image/generic.mk
+index 3ba27aa6597..fa3f3be2955 100644
+--- a/target/linux/ar71xx/image/generic.mk
++++ b/target/linux/ar71xx/image/generic.mk
+@@ -543,6 +543,18 @@ define Device/gl-usb150
+ endef
+ TARGET_DEVICES += gl-usb150
+ 
++define Device/jt-or750i
++  DEVICE_TITLE := Joy-IT JT-OR750i
++  DEVICE_PACKAGES := kmod-ath10k ath10k-firmware-qca9887 kmod-usb-core kmod-usb2
++  BOARDNAME := JT-OR750I
++  IMAGE_SIZE := 16000k
++  MTDPARTS := spi0.0:256k(u-boot)ro,64k(u-boot-env),16000k(firmware),64k(art)ro
++  SUPPORTED_DEVICES := jt-or750i
++  IMAGE/sysupgrade.bin := append-kernel | pad-to $$$$(BLOCKSIZE) |\
++	append-rootfs | pad-rootfs | append-metadata | check-size $$$$(IMAGE_SIZE)
++endef
++TARGET_DEVICES += jt-or750i
++
+ define Device/lan-turtle
+   $(Device/tplink-16mlzma)
+   DEVICE_TITLE := Hak5 LAN Turtle
diff --git a/targets/ar71xx-generic b/targets/ar71xx-generic
index 04d798ab..18e49e57 100644
--- a/targets/ar71xx-generic
+++ b/targets/ar71xx-generic
@@ -126,6 +126,14 @@ device('gl.inet-gl-ar750', 'gl-ar750', {
 })
 
 
+-- Joy-IT
+
+device('joy-it-jt-or750i', 'jt-or750i', {
+        packages = ATH10K_PACKAGES_QCA9887,
+        factory = false,
+})
+
+
 -- Linksys by Cisco
 
 device('linksys-wrt160nl', 'wrt160nl', {
-- 
2.27.0.windows.1

